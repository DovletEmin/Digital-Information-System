{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}Statistika — SMU Digital Library{% endblock %}

{% block extrahead %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#f8fafc;--card:#ffffff;--muted:#6b7280;--accent:#1e3a8a}
body{background:var(--bg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:#111827}
.wrap{max-width:1200px;margin:1.5rem auto;padding:1rem}
.header{display:flex;align-items:center;justify-content:space-between;gap:1rem}
.title{font-size:1.6rem;font-weight:700;color:var(--accent)}
.sub{color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:1rem;margin-top:1rem}
.card{background:var(--card);border-radius:12px;padding:1rem;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
.col-span-4{grid-column:span 4}
.col-span-8{grid-column:span 8}
.stat-big{font-size:2.2rem;font-weight:800;color:#0f172a}
.muted{color:var(--muted)}
.list{display:flex;flex-direction:column;gap:.5rem}
.top-row{display:flex;gap:1rem;flex-wrap:wrap}
.badge{background:#eef2ff;color:#3730a3;padding:.25rem .5rem;border-radius:999px;font-weight:600}
@media(max-width:900px){.col-span-4,.col-span-8{grid-column:span 12}}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
    <div class="header">
        <div>
            <div class="title">SMU Sanly Kitaphanasy — Umumy Statistika</div>
            <div class="sub">Updated: {{ today }}</div>
        </div>
        <div class="top-row">
            <div class="badge">Materials: {{ total_materials }}</div>
            <div class="badge">Users: {{ total_users }}</div>
            <div class="badge">Views: {{ total_views }}</div>
            <div class="badge">Bookmarks: {{ bookmarks_total }}</div>
        </div>
    </div>

    <div class="grid" style="margin-top:1.25rem">
        <div class="card col-span-4">
            <div class="muted">Total articles</div>
            <div class="stat-big">{{ total_articles }}</div>
        </div>
        <div class="card col-span-4">
            <div class="muted">Total books</div>
            <div class="stat-big">{{ total_books }}</div>
        </div>
        <div class="card col-span-4">
            <div class="muted">Total dissertations</div>
            <div class="stat-big">{{ total_dissertations }}</div>
        </div>

        <div class="card col-span-8">
            <div class="muted">Top materials by views</div>
            <canvas id="topChart" height="120"></canvas>
        </div>

        <div class="card col-span-4">
            <div class="muted">Language distribution</div>
            <canvas id="langChart" height="200"></canvas>
            <div style="margin-top:.75rem" class="list">
                <div><strong>TM:</strong> {{ tm_count }} ({{ (tm_count|floatformat:0) }})</div>
                <div><strong>RU:</strong> {{ ru_count }} </div>
                <div><strong>EN:</strong> {{ en_count }} </div>
            </div>
        </div>

        <div class="card col-span-4">
            <div class="muted">Average ratings</div>
            <div style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem">
                <div><strong>Overall:</strong> {{ avg_rating }}</div>
                <div><strong>Articles:</strong> {{ avg_article_rating }}</div>
                <div><strong>Books:</strong> {{ avg_book_rating }}</div>
                <div><strong>Dissertations:</strong> {{ avg_dissertation_rating }}</div>
            </div>
        </div>

        <div class="card col-span-4">
            <div class="muted">New in last 30 days</div>
            <div class="stat-big">{{ new_last_month }}</div>
            <div class="muted" style="margin-top:.5rem">Active last week: {{ active_last_week }}</div>
        </div>

        <div class="card col-span-12">
            <div class="muted">Top items (combined)</div>
            <ul style="margin:0.5rem 0;padding-left:1rem">
                {% for label,value in chart_data_json|safe|json_script:'chart-data' %}{% endfor %}
            </ul>
        </div>

    </div>

</div>

<script>
// parse JSON passed from view
const chartData = JSON.parse('{{ chart_data_json|escapejs }}');
const langData = JSON.parse('{{ language_distribution_json|escapejs }}');

// Top materials bar chart
const ctx = document.getElementById('topChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: chartData.labels,
        datasets: [{ label: 'Views', data: chartData.values, backgroundColor: '#2563eb' }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { maxRotation: 0, autoSkip: true } } } }
});

// Language pie chart
const ctx2 = document.getElementById('langChart').getContext('2d');
new Chart(ctx2, {
    type: 'pie',
    data: { labels: Object.keys(langData), datasets: [{ data: Object.values(langData), backgroundColor: ['#16a34a','#ef4444','#7c3aed'] }] },
    options: { responsive: true, maintainAspectRatio: false }
});
</script>

{% endblock %}
